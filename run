#!/bin/sh

clear

export DISPLAY=:3.0
export SDL_VIDEODRIVER=x11
export SDL_VIDEO_WINDOW_POS=0,0
export SDL_VIDEO_CENTERED=0

Xvfb $DISPLAY -screen 0 192x128x24 &
XVFB_PID=$!

sleep 1

sudo xserver-screen \
        --led-gpio-mapping=regular \
        --led-brightness=60 \
        --led-rows=64 \
        --led-cols=64 \
        --led-chain=3 \
        --led-parallel=2 \
        --led-slowdown-gpio=4 \
        --led-scan-mode=1 \
        --led-limit-refresh=60 \
        --led-pwm-bits=11 \
        --led-panel-type=FM6126A &
XSERVER_PID=$!

sleep 1

echo "===== Running your command: $* ====="
echo "Press any key to quit..."

# Function to listen for key press and kill the command
listen_for_keypress() {
    stty -echo -icanon
    dd if=/dev/tty bs=1 count=1 2>/dev/null
    stty echo icanon
    if [ -n "$XSERVER_PID" ] && kill -0 $XSERVER_PID 2>/dev/null; then
        echo ""
        echo "===== Key pressed, terminating ====="
        sudo kill $XSERVER_PID 2>/dev/null
        kill $XSERVER_PID 2>/dev/null
    fi
}

# Start key listener in background
listen_for_keypress &
LISTENER_PID=$!

"$@" 2>&1

echo "===== Command finished ====="

# Kill the listener if still running
kill $LISTENER_PID 2>/dev/null

# Cleanup
if [ -n "$XSERVER_PID" ] && kill -0 $XSERVER_PID 2>/dev/null; then
    sudo kill $XSERVER_PID
    sleep 1
    # Force kill if still running
    kill -0 $XSERVER_PID 2>/dev/null && sudo kill -9 $XSERVER_PID 2>/dev/null
fi

if [ -n "$XVFB_PID" ] && kill -0 $XVFB_PID 2>/dev/null; then
    kill $XVFB_PID
    sleep 1
    # Force kill if still running
    kill -0 $XVFB_PID 2>/dev/null && kill -9 $XVFB_PID 2>/dev/null
fi
